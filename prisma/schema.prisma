// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Таблица пользователей
model User {
  UserID            String            @id @unique                 // Уникальный идентификатор пользователя
  IsActivated       Boolean           @default(true)              // Признак активации аккаунта
  IsOnline          Boolean           @default(false)             // Признак нахождения пользователя в сети
  Role              String            @default("ADMIN")           // Уровень доступа к ресурсам
  EMail             String            @unique                     // Уникальный адрес электронной почты
  Password          String                                        // Пароль пользователя
  NickName          String            @unique                     // Псевдоним
  Avatar            String?           @default("")                // Аватар
  FirstName         String?           @default("")                // Имя
  LastName          String?           @default("")                // Фамилия
  Department        String?           @default("")                // Подразделение
  AboutMe           String?           @default("")                // Краткое описание о себе
  Country           String?           @default("")                // Страна
  Region            String?           @default("")                // Регион (штат, область...)
  City              String?           @default("")                // Город
  Address           String?           @default("")                // Адрес
  PostCode          String?           @default("")                // Почтовый индекс
  PhoneNumber       String?           @default("")                // Номер телефона
  Tags              Json                                          // Теги для привязки устройств
  AccessToken       String?           @default("")                // Токен доступа к ресурсу
  RefreshToken      String?           @default("")                // Токен для перезапроса токена доступа к ресурсу
  Created           DateTime          @default(now())             // Дата создания профиля пользователя
  Updated           DateTime          @updatedAt                  // Дата редактирования профиля пользователя

  Devices           UserDevice[]                                  // Связь с устройствами пользователя
  News              News[]            @relation                   // Связь с новостями
  Groups            Group[]           @relation("UserGroups")     // Связь с чатами
  Messages          GroupMessage[]                                // Связь с сообщениями, которые отправил пользователь
  
  @@map("Users")                                                  // Имя таблицы в базе данных
}

// Таблица новостей
model News {
  NewsID            String            @id @unique                 // Уникальный идентификатор новости
  UserID            String?                                       // Идентификатор пользователя, 
  Title             String                                        // Заголовок новости
  Brief             String                                        // Краткое описание
  Content           String                                        // Полное содержимое новости
  ImageTitle        String?                                       // Изображение для заголовка новости
  ImageContent      String?                                       // изображение в теле новости
  Published         Boolean           @default(false)             // Признак доступности новости
  Created           DateTime          @default(now())             // Дата создания новости
  Updated           DateTime          @updatedAt                  // Дата изменения новости

  Author            User?             @relation(fields: [UserID], references: [UserID], onDelete: SetNull)

  @@map("News")                                                   // Имя таблицы в базе данных
}

// Таблица устройств в каталоге
model CatalogDevice {
  CatalogID         String            @id @unique                 // Уникальный идентификатор устройства по каталогу
  CatalogName       String            @default("PAS-Module")      // Имя устройство по умолчанию
  Brief             String                                        // Краткое описание устройтсва
  Icon              String                                        // Иконка
  VerFW             String                                        // Последняя версия прошивки
  Created           DateTime          @default(now())             // Дата создания устройства
  Updated           DateTime          @updatedAt                  // Дата обновления устройства

  Versions          CatalogVersion[]  @relation("DeviceVersions") // Связь с версиями прошивок
  Devices           Device[]

  @@map("CatalogDevices")                                         // Имя таблицы в базе данных
}

// Таблица конкретной версии устройства из каталога (с описанием, прошивкой, руководством, API и мета данными)
model CatalogVersion {
  VerFW             String                                        // Версия прошивок
  Description       String                                        // Подробное описание устройства
  Firmware          Bytes                                         // Бинарные данные прошивки
  Manual            Bytes                                         // Бинарные данные руководства пользователя
  API               Bytes                                         // Бинарные данные API (YAML файл с описание интерфейса)
  MetaData          Json                                          // Мета данные прошивки (ID устройство, версия прошивки, CRC32 прошивки)
  Created           DateTime          @default(now())             // Дата создания прошивки
  Updated           DateTime          @updatedAt                  // Дата обновления прошивки

  DeviceID          String                                        // Идентификатор устройства
  CatalogDevice     CatalogDevice     @relation("DeviceVersions", fields: [DeviceID], references: [CatalogID])

  @@id([DeviceID, VerFW])                                         // Уникальный составной ключ (версия + идентификатор устройства)
  @@map("CatalogVersions")                                        // Имя таблицы в базе данных
}

// Таблица реальных (физических) устройств
model Device {
  DevSN             String            @id @unique                 // Серийный номер устройства
  DevID             String                                        // Идентификатор устройства по каталогу
  DevName           String                                        // Имя устройства
  DevFW             String                                        // Версия прошивки
  IsOnline          Boolean           @default(false)             // Признак нахождения устройство в сети
  Modules           Json?                                         // Список модулей в виде JSON
  
  Users             UserDevice[]                                  // Обратная связь с UserDevice
  Messages          GroupMessage[]                                // Обратная связь с GroupMessage
  Catalog           CatalogDevice         @relation(fields: [DevID], references: [CatalogID])
  
  @@map("Devices")                                                // Имя таблицы в базе данных
}

// Промежуточная таблица для связи Многие-ко-Многим между User и Device
model UserDevice {
  UserID            String                                        // Идентификатор пользователя
  DevSN             String                                        // Серийный номер устройства
  TagID             String                                        // Тег привязки

  User              User              @relation(fields: [UserID], references: [UserID], onDelete: Cascade)
  Device            Device            @relation(fields: [DevSN], references: [DevSN], onDelete: Cascade)

  @@id([UserID, DevSN])                                           // Уникальный идентификатор (составной ключ) 
  @@map("UserDevices")                                            // Имя таблицы в базе данных
}

// Таблица с группами
model Group {
  GroupID           String            @id @unique                 // Уникальный идентификатор группы
  GroupName         String            @unique                     // Уникальное имя группы

  GroupMessages     GroupMessage[]                                // Связь с сообщениями в этом чате
  Participants      User[]            @relation("UserGroups")     // Участники чата

  @@map("Groups")                                                 // Имя таблицы в базе данных
}

// Таблица сообщений
model GroupMessage {
  MessageID         String            @id @default(cuid())        // Уникальный идентификатор сообщения
  GroupID           String                                        // Идентификатор группы
  UserID            String?                                       // Идентификатор пользователя
  DevSN             String?                                       // Серийный номер устройство
  Message           String                                        // Содержимое сообщения
  Created           DateTime          @default(now())             // Дата создания сообщения

  Author            User?             @relation(fields: [UserID], references: [UserID])   // Связь с пользователем
  Device            Device?           @relation(fields: [DevSN], references: [DevSN])     // Связь с устройством
  Group             Group             @relation(fields: [GroupID], references: [GroupID]) // Связь с чатом

  @@map("GroupMessages")                                          // Имя таблицы в базе данных
}
